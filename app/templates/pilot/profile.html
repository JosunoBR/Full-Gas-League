{% extends "base.html" %}

{% block content %}

{% if checkin_race %}
<div class="card shadow-lg border-silver mb-4 animate-alert">
    <div class="card-body bg-dark d-flex flex-column flex-md-row justify-content-between align-items-center p-4">
        <div class="mb-3 mb-md-0">
            <h4 class="text-danger fw-bold mb-1">
                <i class="fa-solid fa-flag-checkered me-2"></i> CHECK-IN DE PRESENÇA
            </h4>
            <p class="text-white mb-0">
                Confirme sua participação no <strong>{{ checkin_race.nome_gp }}</strong> 
                ({{ checkin_race.data_corrida.strftime('%d/%m') }}).
            </p>
            
            {% if registro_atual %}
                <div class="mt-2">
                    {% if registro_atual.status == 'CONFIRMADO' %}
                        <span class="badge bg-success text-white fs-6">
                            <i class="fa-solid fa-check me-1"></i> Presença Confirmada
                        </span>
                    {% else %}
                        <span class="badge bg-danger text-white fs-6 fw-bold">
                            <i class="fa-solid fa-triangle-exclamation me-1"></i> Ausência Reportada
                        </span>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <div class="d-flex gap-2">
            <form action="{{ url_for('public.checkin_confirm', race_id=checkin_race.id) }}" method="POST">
                <button type="submit" class="btn btn-success fw-bold px-4 py-2 text-white">
                    <i class="fa-solid fa-thumbs-up me-2"></i> VOU CORRER
                </button>
            </form>
            
            <button type="button" class="btn btn-outline-danger fw-bold px-4 py-2 text-white" data-bs-toggle="modal" data-bs-target="#modalAusencia">
                <i class="fa-solid fa-thumbs-down me-2"></i> NÃO VOU
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAusencia" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-danger fw-bold">Reportar Ausência</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('public.checkin_absent', race_id=checkin_race.id) }}" method="POST">
                <div class="modal-body">
                    <p class="text-white-50">Infelizmente você não poderá correr. Por favor, informe o motivo para a direção de prova (obrigatório para evitar W.O):</p>
                    <textarea name="justificativa" class="form-control bg-secondary text-white border-0" rows="3" placeholder="Ex: Trabalho, Viagem, PC quebrou..." required></textarea>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary text-white" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger fw-bold text-white">ENVIAR AVISO</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}


<div class="row mb-4">
    
    <div class="col-md-4 mb-3">
        <div class="card shadow-lg border-secondary text-center h-100">
            <div class="card-body bg-dark text-white p-4 d-flex flex-column justify-content-center">
                
                <div class="mb-3 position-relative d-inline-block mx-auto">
                    {% if perfil.foto_url %}
                        <img src="{{ url_for('static', filename='uploads/' + perfil.foto_url) }}" class="rounded-circle border border-danger p-1" width="140" height="140" style="object-fit: cover;">
                    {% else %}
                        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto border border-danger p-1" style="width: 140px; height: 140px;">
                            <i class="fa-solid fa-user fa-4x text-dark"></i>
                        </div>
                    {% endif %}
                    <span class="position-absolute bottom-0 end-0 badge rounded-pill bg-dark text-danger border border-danger fw-bold">
                        {{ perfil.grid }}
                    </span>
                </div>

                <h3 class="fw-bold mb-0 text-white">
                    {{ perfil.nickname }}
                    {% if perfil.user.role in ['ADM', 'SUPER_ADM'] %}
                        <span class="badge bg-danger text-white ms-2 fs-6 align-middle" title="Administrador do Sistema"><i class="fa-solid fa-user-shield"></i> ADM</span>
                    {% endif %}
                </h3>
                <p class="text-white-50 small mb-1">{{ perfil.nome_real }}</p>
                
                {% if perfil.team %}
                    <a href="{{ url_for('public.team_profile', team_id=perfil.team.id) }}" class="badge bg-dark border border-danger text-danger text-decoration-none mb-4 px-3 py-2">
                        {{ perfil.team.nome }}
                    </a>
                {% else %}
                    <span class="badge bg-dark border border-secondary text-white mb-4 px-3 py-2">Sem Equipe</span>
                {% endif %}
                
                <div class="row g-2 mb-4">
                    <div class="col-4">
                        <div class="p-2 border border-secondary rounded bg-dark h-100">
                            <small class="text-white-50" style="font-size:0.7rem">PONTOS</small><br>
                            <span class="fs-4 fw-bold text-white">{{ meus_pontos_camp|int }}</span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 border border-secondary rounded bg-dark h-100">
                            <small class="text-white-50" style="font-size:0.7rem">CNH</small><br>
                            <span class="fs-4 fw-bold {% if perfil.pontos_cnh <= 5 %}text-danger{% else %}text-success{% endif %}">
                                {{ perfil.pontos_cnh }}
                            </span>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-2 border border-secondary rounded bg-dark h-100">
                            <small class="text-white-50" style="font-size:0.7rem">ADV</small><br>
                            <span class="fs-4 fw-bold text-danger">{{ perfil.advertencias_acumuladas }}</span>
                        </div>
                    </div>
                </div>

                {% if is_owner %}
                <div class="d-grid gap-2 mt-auto">
                    <button class="btn btn-outline-light btn-sm text-white" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="fa-solid fa-pen-to-square"></i> Editar Perfil
                    </button>
                    <a href="{{ url_for('public.open_protest') }}" class="btn btn-red fw-bold text-white">
                        <i class="fa-solid fa-gavel"></i> PEDIDO DE PUNIÇÃO
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8 mb-3">
        <div class="card shadow-lg border-secondary h-100">
             <div class="card-header bg-dark border-secondary">
                 <h5 class="mb-0 text-danger fw-bold"><i class="fa-solid fa-chart-line me-2"></i> Desempenho na Temporada</h5>
             </div>
             <div class="card-body bg-dark p-0">
                 <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead>
                            <tr class="text-white-50 small">
                                <th class="ps-3">GP</th>
                                <th class="text-center">Data</th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Posição</th>
                                <th class="text-center pe-3">Pontos</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in desempenho_temporada %}
                            <tr>
                                <td class="ps-3 fw-bold text-white">{{ c.gp }}</td>
                                <td class="text-center text-white-50 small">
                                    {% if c.data %}{{ c.data.strftime('%d/%m') }}{% else %}-{% endif %}
                                </td>
                                <td class="text-center">
                                    {% if c.status_corrida == 'Agendada' %}
                                        <span class="badge bg-secondary text-white">Em Breve</span>
                                    {% elif not c.participou %}
                                        <span class="badge bg-dark border border-secondary text-white">Ausente</span>
                                    {% else %}
                                        <span class="badge bg-success text-white">Participou</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if c.dnf %}
                                        <span class="badge bg-danger text-white">DNF</span>
                                    {% elif c.dsq %}
                                        <span class="badge bg-dark text-danger border border-danger">DSQ</span>
                                    {% elif c.participou %}
                                        <span class="fs-5 fw-bold text-white">{{ c.posicao }}º</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-center pe-3 fw-bold text-danger">
                                    {% if c.dsq %}
                                        0
                                    {% else %}
                                        {{ c.pontos|int }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-white-50">Nenhuma corrida registrada ainda.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                 </div>
             </div>
        </div>
    </div>
</div>

{% if is_owner %}
<div class="row g-4 mb-5">
    
    {% if defesas_pendentes %}
    <div class="col-12">
        <div class="card border-danger shadow">
            <div class="card-header bg-danger text-white fw-bold">
                <i class="fa-solid fa-triangle-exclamation me-2"></i> VOCÊ FOI DENUNCIADO - APRESENTE DEFESA
            </div>
            <div class="card-body bg-dark">
                {% for p in defesas_pendentes %}
                <div class="d-flex justify-content-between align-items-center border-bottom border-secondary pb-2 mb-2">
                    <div>
                        <strong class="text-white">{{ p.etapa.nome_gp }}</strong>
                        <span class="text-white-50 small ms-2">Acusador: {{ p.acusador.nickname }}</span>
                        <p class="text-white-50 small mb-0 mt-1">"{{ p.descricao }}"</p>
                    </div>
                    <a href="{{ url_for('public.submit_defense', protest_id=p.id) }}" class="btn btn-danger btn-sm fw-bold text-white">
                        DEFENDER-SE
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="col-md-6">
        <div class="card shadow border-secondary h-100">
            <div class="card-header bg-dark border-secondary text-white fw-bold">
                <i class="fa-solid fa-gavel me-2"></i> Meus Protestos Enviados
            </div>
            <div class="card-body bg-dark p-0">
                <ul class="list-group list-group-flush">
                    {% for p in meus_protestos %}
                    <li class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ p.etapa.nome_gp }}</strong>
                                <span class="d-block small text-white-50">Contra: {{ p.acusado.nickname }}</span>
                            </div>
                            {% if p.status == 'CONCLUIDO' %}
                                <span class="badge bg-secondary text-white">Concluído</span>
                            {% elif p.status == 'AGUARDANDO_DEFESA' %}
                                <span class="badge bg-danger text-white fw-bold">Aguardando Defesa</span>
                            {% else %}
                                <span class="badge bg-info text-dark fw-bold">Em Julgamento</span>
                            {% endif %}
                        </div>
                        
                        {% if p.status != 'CONCLUIDO' %}
                        <div class="mt-2 text-end">
                            <form action="{{ url_for('public.delete_protest', protest_id=p.id) }}" method="POST" onsubmit="return confirm('Cancelar este protesto?');">
                                <button class="btn btn-outline-danger btn-sm text-white" style="font-size: 0.7rem;">Cancelar Protesto</button>
                            </form>
                        </div>
                        {% endif %}
                    </li>
                    {% else %}
                    <li class="list-group-item bg-dark text-white-50 text-center py-3">Nenhum protesto enviado.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow border-secondary h-100">
            <div class="card-header bg-dark border-secondary text-white fw-bold d-flex justify-content-between align-items-center">
                <span><i class="fa-solid fa-file-contract me-2"></i> Histórico de Punições</span>
                <span class="text-white">Total: <span class="text-danger">{{ total_punicoes }}</span></span>
            </div>
            <div class="card-body bg-dark p-0">
                <ul class="list-group list-group-flush">
                    {% for h in historico %}
                    <li class="list-group-item bg-dark text-white border-secondary">
                        <div class="d-flex justify-content-between">
                            <strong>{{ h.etapa.nome_gp }}</strong>
                            {% if h.veredito_final == 'INOCENTE' or h.veredito_final == 'INCIDENTE_CORRIDA' %}
                                <span class="badge bg-success text-white">{{ h.veredito_final }}</span>
                            {% else %}
                                <span class="badge bg-danger text-white">{{ h.veredito_final }}</span>
                            {% endif %}
                        </div>
                        <p class="small text-white-50 mb-0 mt-1"><em>"{{ h.justificativa_texto }}"</em></p>
                    </li>
                    {% else %}
                    <li class="list-group-item bg-dark text-white-50 text-center py-3">Ficha limpa! Nenhuma punição registrada.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if historico_carreira %}
<div class="row mb-5">
    <div class="col-12">
        <h5 class="text-white-50 mb-3 ps-2 border-start border-danger border-4">Histórico de Carreira</h5>
        <div class="table-responsive">
            <table class="table table-dark table-sm border border-secondary">
                <thead>
                    <tr class="text-white-50">
                        <th>Temporada</th>
                        <th>Grid</th>
                        <th>Pontos</th>
                        <th>Vitórias</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in historico_carreira %}
                    <tr>
                        <td class="text-white">{{ s.season_nome }}</td>
                        <td class="text-white">{{ s.grid }}</td>
                        <td class="text-white">{{ s.pontos|int }}</td>
                        <td class="text-white">{{ s.vitorias }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Editar Perfil</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('public.update_profile') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-white-50">Nome Real</label>
                        <input type="text" name="nome_real" class="form-control bg-secondary text-white border-0" value="{{ current_user.pilot_profile.nome_real }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Nickname (Pista)</label>
                        <input type="text" name="nickname" class="form-control bg-secondary text-white border-0" value="{{ current_user.pilot_profile.nickname }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Telefone (WhatsApp)</label>
                        <input type="text" name="telefone" class="form-control bg-secondary text-white border-0" value="{{ current_user.pilot_profile.telefone or '' }}" placeholder="(00) 00000-0000" oninput="maskPhone(this)" maxlength="15">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Alterar Foto</label>
                        <input type="file" name="foto" class="form-control bg-secondary text-white border-0">
                        <div class="form-text text-white-50">Formatos: JPG, PNG. Max 2MB.</div>
                    </div>
                    
                    <hr class="border-secondary my-4">
                    <h6 class="text-danger mb-3 fw-bold"><i class="fa-solid fa-lock me-2"></i> Alterar Senha (Opcional)</h6>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Nova Senha</label>
                        <input type="password" name="password" class="form-control bg-secondary text-white border-0" placeholder="Deixe em branco para manter a atual">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">Confirmar Nova Senha</label>
                        <input type="password" name="confirm_password" class="form-control bg-secondary text-white border-0" placeholder="Repita a nova senha">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary text-white" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger fw-bold text-white">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .animate-alert {
        animation: slideDown 0.5s ease-out;
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

{% endblock %}